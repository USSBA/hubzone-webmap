//= require hzmap
//= require ../helpers/sinon-1.17.6
//= require ../helpers/hz-jasmine
/* jshint unused: false */
/* jshint undef: false */

describe ('Testing map operations', function() {
  beforeEach(function(){
    google = HZSpecHelper.google;
    HZApp.map = new google.maps.Map();
    spyOn(google.maps, 'Map').and.returnValue(HZApp.map);
    spyOn(google.maps.event, 'addListener');
    spyOn(HZApp.map, 'addListener');
    HZSpecHelper.resetOverlays();
    HZApp.Markers.hzUserLocation = new HZApp.Constructors.HubzoneMapMarker({icon: null});  
  });

  afterEach(function(){
    HZApp.map = {};
    HZApp.Markers.hzUserLocation = {};
  });

  it("should create a new Google map", function() {
    spyOn(google.maps, 'StyledMapType');
    spyOn(HZApp.map.mapTypes, 'set');
    spyOn(HZApp.map, 'setMapTypeId');
    spyOn(google.maps.places, 'Autocomplete');
    spyOn(HZApp.GeoLocation, 'getUserLocation');  
    spyOn(HZApp.Autocomplete, 'createAutocomplete');

    HZApp.map.controls[google.maps.ControlPosition.LEFT_BOTTOM] = [];
    HZApp.map.controls[google.maps.ControlPosition.TOP_RIGHT] = [];
    HZApp.map.controls[google.maps.ControlPosition.RIGHT_BOTTOM] = [];

    expect(initMap()).not.toBe(null);
    expect(google.maps.Map.calls.count()).toEqual(1);
    expect(google.maps.event.addListener.calls.count()).toEqual(1);
    expect(google.maps.StyledMapType.calls.count()).toEqual(1);
    expect(HZApp.map.addListener.calls.count()).toEqual(1);
    expect(HZApp.map.mapTypes.set.calls.count()).toEqual(1);
    expect(HZApp.map.setMapTypeId.calls.count()).toEqual(1);
    expect(HZApp.GeoLocation.getUserLocation.calls.count()).toEqual(1);
    expect(HZApp.Autocomplete.createAutocomplete.calls.count()).toEqual(1);
  });

  it("should get bbox", function() {
    var mapBounds = HZApp.map.getBounds();
    spyOn(mapBounds, 'getNorthEast').and.callThrough();
    spyOn(mapBounds, 'getSouthWest').and.callThrough();

    expect(HZApp.MapUtils.getBbox(mapBounds)).toEqual("-98.35693359375,34.99419475828389,-96.64306640625,36.00264017338637");
    expect(mapBounds.getNorthEast.calls.count()).toEqual(2);
    expect(mapBounds.getSouthWest.calls.count()).toEqual(2);
  });

  it("should return correct imageBounds object", function(){
    spyOn(HZApp.MapUtils, 'createGoogleLatLngBounds');
    var coordinates = HZSpecHelper.coordinates;
    var bboxStr = [coordinates.west, coordinates.south, coordinates.east, coordinates.north].join(',');

    var imageBounds = HZApp.MapUtils.getImageBounds(bboxStr);
    expect(imageBounds).not.toBe(null);
    expect(HZApp.MapUtils.createGoogleLatLngBounds).toHaveBeenCalled();
  });

  it("should run google latlng methods", function(){
    var coordinates = HZSpecHelper.coordinates;
    spyOn(google.maps, 'LatLngBounds');
    spyOn(google.maps, 'LatLng');

    HZApp.MapUtils.createGoogleLatLngBounds(coordinates.west, coordinates.south, coordinates.east, coordinates.north);
    expect(google.maps.LatLngBounds.calls.count()).toEqual(1);
    expect(google.maps.LatLng.calls.count()).toEqual(2);
  });

  it("should build the correct URL for data with expiration", function() {
    var mapBounds = HZApp.map.getBounds();
    var bbox = HZApp.MapUtils.getBbox(mapBounds);
    var layer = 'qct';
    var url = HZApp.MapUtils.buildWMSUrl({
      layer: layer,
      bbox: bbox});
    /* jshint ignore:start */
    var wmsURL = "<%= ENV["HUBZONE_WMS_URL_ROOT"] || "http://localhost:8080/geoserver/hubzone/wms?service=WMS" %>";
    var wmsWorkspace =  "<%= ENV["HUBZONE_WMS_WORKSPACE"] || "hubzone" %>";
    /* jshint ignore:end */
    var urlExpect = wmsURL + '&REQUEST=GetMap&SERVICE=WMS&VERSION=1.1.0&LAYERS=' + wmsWorkspace + ':' +
                    layer +
                    '&FORMAT=image/png&TRANSPARENT=TRUE&SRS=EPSG:4326&BBOX=-98.35693359375,34.99419475828389,-96.64306640625,36.00264017338637&WIDTH=0&HEIGHT=0&SLD_BODY=' +
                    HZApp.Layers.constructSLDXML(layer);
    expect(url).toEqual(urlExpect);
  });

  it("should build the correct URL for data without expiration", function() {
    var mapBounds = HZApp.map.getBounds();
    var bbox = HZApp.MapUtils.getBbox(mapBounds);
    var layer = 'indian_lands';
    var url = HZApp.MapUtils.buildWMSUrl({
      layer: layer,
      bbox: bbox});
    /* jshint ignore:start */
    var wmsURL = "<%= ENV["HUBZONE_WMS_URL_ROOT"] || "http://localhost:8080/geoserver/hubzone/wms?service=WMS" %>";
    var wmsWorkspace =  "<%= ENV["HUBZONE_WMS_WORKSPACE"] || "hubzone" %>";
    /* jshint ignore:end */
    var urlExpect = wmsURL + '&REQUEST=GetMap&SERVICE=WMS&VERSION=1.1.0&LAYERS=' + wmsWorkspace + ':' +
                    layer +
                    '&FORMAT=image/png&TRANSPARENT=TRUE&SRS=EPSG:4326&BBOX=-98.35693359375,34.99419475828389,-96.64306640625,36.00264017338637&WIDTH=0&HEIGHT=0&SLD_BODY=' +
                    HZApp.Layers.constructSLDXML(layer);
    expect(url).toEqual(urlExpect);
  });

  it("should call the wms map layer stack", function(){
    spyOn(HZApp.MapUtils, 'getBbox');
    spyOn(HZApp.MapUtils, 'getImageBounds');
    spyOn(HZApp.MapUtils, 'buildWMSUrl');
    spyOn(HZApp.MapUtils, 'updateLayerWMSOverlay');
    spyOn(google.maps, 'GroundOverlay');

    HZApp.MapUtils.fetchNewWMS({
      mapScope: HZApp.map,
      layer: 'qct'
    });

    expect(HZApp.MapUtils.getBbox.calls.count()).toEqual(1);
    expect(HZApp.MapUtils.getImageBounds.calls.count()).toEqual(1);
    expect(HZApp.MapUtils.buildWMSUrl.calls.count()).toEqual(1);
    expect(HZApp.MapUtils.updateLayerWMSOverlay.calls.count()).toEqual(1);
    expect(google.maps.GroundOverlay.calls.count()).toEqual(1);
  });

  it("should fetchNewWMS for as many layers as are defined", function(){
    spyOn(HZApp.MapUtils, 'fetchNewWMS');
    HZApp.MapUtils.updateIdleMap(HZApp.map);
    var layerLength = Object.keys(HZApp.Layers.hzWMSOverlays).length;
    expect(HZApp.MapUtils.fetchNewWMS.calls.count()).toEqual(layerLength);
  });

  it("should update the map WMS layer, adding a new overlay where there was none before", function(){
    var layer = 'qct';
    var mockOverlay = new HZSpecHelper.NewOverlay('new');
    spyOn(mockOverlay, 'setMap');
    spyOn(mockOverlay, 'addListener');
    HZApp.Layers.hzWMSOverlays[layer].overlay.push(mockOverlay);

    HZApp.MapUtils.updateLayerWMSOverlay({
      layer: layer,
      mapScope: HZApp.map
    });

    expect(mockOverlay.setMap.calls.count()).toEqual(1);
    expect(mockOverlay.addListener.calls.count()).toEqual(1);
  });

  it("should update the map WMS layer, replacing the old overlay with a new one", function(){
    var layer = 'qct';

    var mockOverlayOld = new HZSpecHelper.NewOverlay('old');
    var mockOverlayNew = new HZSpecHelper.NewOverlay('new');

    spyOn(mockOverlayOld, 'setMap');
    spyOn(mockOverlayNew, 'setMap');
    spyOn(mockOverlayNew, 'addListener');
    HZApp.Layers.hzWMSOverlays[layer].overlay.push(mockOverlayOld);
    HZApp.Layers.hzWMSOverlays[layer].overlay.push(mockOverlayNew);

    HZApp.MapUtils.updateLayerWMSOverlay({
      layer: layer,
      mapScope: HZApp.map
    });

    expect(mockOverlayNew.setMap.calls.count()).toEqual(1);
    expect(mockOverlayNew.addListener.calls.count()).toEqual(1);
  });

  it("should handle an empty WMS update call", function(){
    var layer = 'qct';
    HZSpecHelper.resetOverlays();
    var updateState = HZApp.MapUtils.updateLayerWMSOverlay({
      layer: layer,
      mapScope: HZApp.map
    });
    expect(updateState).toBe(null);
  });

  it("should parse a viewport to LatLngBounds and send it to fitBounds", function(){
    spyOn(google.maps, 'LatLngBounds');
    spyOn(google.maps, 'LatLng');
    spyOn(HZApp.map, 'fitBounds');

    var geocodeLocation = {
      location: HZSpecHelper.markerLocation,
      viewport: {
        northeast: {
          lat: 39.29024048029149,
          lng: -76.60564721970849
        },
        southwest: {
          lat: 39.2875425197085,
          lng: -76.6083451802915
        }
      }
    };

    HZApp.MapUtils.jumpToLocation(geocodeLocation);
    expect(google.maps.LatLngBounds.calls.count()).toEqual(1);
    expect(google.maps.LatLng.calls.count()).toEqual(2);
    expect(HZApp.map.fitBounds.calls.count()).toEqual(1);
  });

  it("should pass over a geocodeLocation that does not contain a viewport, doing nothing", function(){
    spyOn(HZApp.map, 'fitBounds');

    var geocodeLocationNoViewport = {
      location: HZSpecHelper.markerLocation
    };

    HZApp.MapUtils.jumpToLocation(geocodeLocationNoViewport);
    expect(HZApp.map.fitBounds.calls.count()).toEqual(0);
  });

  it("should return a correctly formatted url request on map click", function(){
    var mapClick = {
      latLng: {
        lat: function(){
          return HZSpecHelper.markerLocation.lat;
        },
        lng: function(){
          return HZSpecHelper.markerLocation.lng;
        }
      }
    };

    var date = HZApp.MapUtils.parseDate(new Date());
    var latlngUrl = '<%= search_path %>?latlng=' + mapClick.latLng.lat() + ',' + mapClick.latLng.lng() +
                    '&query_date=' + date +
                    '&locale=en';
    var clickUrl = HZApp.MapUtils.catchMapClick(mapClick);
    expect(clickUrl).toEqual(latlngUrl);
  });

  it("should parse single digit dates correctly", function(){
    var date = HZApp.MapUtils.parseDate(new Date('1/1/2016'));
    expect(date).toEqual('2016-01-01');
  });

  // it("should show autocomplete results when a search is started", function(){
  //   var testDivForAutocomplete = document.createElement('pac-test');
  //   $('body').append(testDivForAutocomplete);
  //   var autoCompleteResults = '<div class="pac-container pac-logo" style="width: 500px; position: absolute; left: 260px; top: 145px; display: none;">' +
  //     '<div class="pac-item"><span class="pac-icon pac-icon-marker"></span><span class="pac-item-query"><span class="pac-matched">8</span>29</span><span>North Charles Street, Baltimore, MD, United States</span></div>' +
  //     '<div class="pac-item"><span class="pac-icon pac-icon-marker"></span><span class="pac-item-query"><span class="pac-matched">8</span>27</span><span>Washington Boulevard, Baltimore, MD, United States</span></div>' +
  //     '<div class="pac-item"><span class="pac-icon pac-icon-marker"></span><span class="pac-item-query"><span class="pac-matched">8</span>88</span><span>South Broadway, Baltimore, MD, United States</span></div>' +
  //     '<div class="pac-item"><span class="pac-icon pac-icon-marker"></span><span class="pac-item-query"><span class="pac-matched">8</span>20</span><span>Frederick Avenue, Baltimore, MD, United States</span></div>' +
  //     '<div class="pac-item"><span class="pac-icon pac-icon-marker"></span><span class="pac-item-query"><span class="pac-matched">8</span>01</span><span>Cherry Hill Road, Baltimore, MD, United States</span></div>' +
  //     '</div>';
  //   $(testDivForAutocomplete).append(autoCompleteResults);
  // });

});
