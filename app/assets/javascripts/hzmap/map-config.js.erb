//defining global variables for hubzone map controllers
var map = {}; //the map object
var infoWindow = {}; //infowindow object
var apiKey = '<%= MAP_CONFIG[:google_api_key] %>'; //google maps api key
var currentFeaturesIDs = [];
var geocodeQuery = ''; // string of geocodequery from input text
var geomUniqID = 'id';
var googleCDNURL = 'https://maps.googleapis.com/maps/api/js?key=<%=MAP_CONFIG[:google_api_key]%>'
var mapMarkers = [];

var geomWFSSettings = JSON.parse('<%= MAP_CONFIG[:geomWFSSettings].to_json %>');

//define a new MapGeoJson class function
var MapGeoJson = function(){

  this.emptyGeoJson = function(){
    return {
      type: 'FeatureCollection',
      crs: {
        type: "name",
        properties: {
          name: "urn:ogc:def:crs:EPSG::4326"
        }
      },
      totalFeatures: 0,
      features: []
    }
  };

  this.uniqueID = '';

  //holders for the current features already rendered in the map
  this.currentFeatures = new this.emptyGeoJson;;
  this.currentFeaturesIDs = [];
  
  //holders for the new features that just arrived
  this.newFeaturesIDs = [];
  this.newFeatures = [];
  
  //holders for the features that are in the process of being updated, will become new current
  this.updatedFeaturesIDs = [];
  this.updatedFeatures = [];
  
  //holders for the output features to add or remove, fed to google maps later.
  this.featuresToAdd = new this.emptyGeoJson;
  this.featuresToRemove = [];

  this.diffData = function(newData){
    this.featuresToRemove = [];
    this.featuresToAdd.features = [];
    this.featuresToAdd.totalFeatures = 0;
    
    if (this.currentFeaturesIDs.length === 0){
      this.featuresToAdd.features = newData.features;
      this.featuresToAdd.totalFeatures = newData.totalFeatures
      this.currentFeatures.features = this.featuresToAdd.features;
      this.currentFeatures.totalFeatures = this.featuresToAdd.totalFeatures;
      for (var i = 0; i < newData.features.length; i++) {
        var properties = newData.features[i].properties;
        this.currentFeaturesIDs.push(properties['hztype'] + '_' + properties['res'] + '_' + properties['sourceid']);
      }
    } else {
      //get the ids of all the new features in one array and the features in another
      this.newFeaturesIDs = [];
      this.newFeatures = newData.features.map(function(feature){
        var featureID = feature.properties['hztype'] + '_' + feature.properties['res'] + '_' + feature.properties['sourceid'];
        this.newFeaturesIDs.push(featureID);
        return feature;
      }, this);

      this.updatedFeaturesIDs = [];
      this.updatedFeatures = [];

      //compare the new feature ids with the current feature ids, 
      //if any are missing from the current features, add them to the map and the 'updatedfeatures'
      for (var j = 0; j < this.newFeaturesIDs.length; j++) {
        if (this.currentFeaturesIDs.indexOf(this.newFeaturesIDs[j]) === -1){
          
          //these are new and need to get added by google maps
          this.featuresToAdd.features.push(this.newFeatures[j]);
          this.featuresToAdd.totalFeatures += 1;

          //these will become the current complete list of features
          this.updatedFeatures.push(this.newFeatures[j]);
          this.updatedFeaturesIDs.push(this.newFeaturesIDs[j]);
        }
      }
      //go across teh current features, if any are not in newfeatures, remove
      //else push them into updatedFeatures, which becomes the complete list
      for (var k = 0; k < this.currentFeaturesIDs.length; k++) {
        if (this.newFeaturesIDs.indexOf(this.currentFeaturesIDs[k]) === -1){
          var properties = this.currentFeatures.features[k].properties;
          this.featuresToRemove.push(properties['hztype'] + '_' + properties['res'] + '_' + properties['sourceid']);
        } else {
          this.updatedFeatures.push(this.currentFeatures.features[k]);
          this.updatedFeaturesIDs.push(this.currentFeaturesIDs[k]);
        }
      }
      this.currentFeaturesIDs = this.updatedFeaturesIDs;
      this.currentFeatures.features = this.updatedFeatures;
      this.currentFeatures.totalFeatures = this.updatedFeatures.length;
    }
  };
};

//create a new mapGeoJson class object
var mapGeoJson = new MapGeoJson();
mapGeoJson.uniqueID = geomUniqID;
