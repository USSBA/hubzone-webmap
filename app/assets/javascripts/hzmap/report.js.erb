// reporting utility
HZApp.Report = (function(){

  //adds listeners
  $(function() {
    $(document).bind("keydown", HZApp.Report.catchKeyStrokeToPrint);
    $(document).on('click','#map-print', HZApp.Report.requestReport);
  });

  return {
    catchKeyStrokeToPrint: function(e){
      if((e.ctrlKey || e.metaKey) && e.keyCode === 80){
        e.preventDefault();
        HZApp.Report.requestReport();
      } else {
        return;
      }
    },
    requestReport: function() {  // fetch the app state to send off to the report
      HZApp.Report.showReportWaiting();

      var url = "<%= MAP_CONFIG[:hubzone_report_host] + MAP_CONFIG[:hubzone_api_report_path] %>"; //jshint ignore:line
      url += HZApp.Report.getReportRequestParams(HZApp.HZQuery);

      var request_type = "<%= MAP_CONFIG[:hubzone_report_request_type] %>"; //jshint ignore:line
      if (request_type === "window_open"){
        window.open(url, '_blank');
      } else {
        var req = new XMLHttpRequest();
        req.open("GET", url, true);
        req.responseType = "blob";
        req.onerror = HZApp.Report.requestReportError;
        req.onload = function (event) { // jshint ignore: line
          HZApp.Report.hideReportWaiting();
          var blob = req.response;
          var link = document.createElement('a');
          link.target = '_blank';
          link.href = window.URL.createObjectURL(blob);
          link.download = ("hz_report" + "_address_" + 
                           HZApp.HZQuery.formatted_address.replace(' ', '_') + ".pdf");
          link.click();
          window.URL.revokeObjectURL(link.href);
        };

        req.send();
      }
    },
    //takes a hzQuery object as input and parses it for a report GET
    getReportRequestParams:function(hzQuery){
      var params = {};
      params.hubzone = encodeURIComponent(JSON.stringify(hzQuery.hubzone));
      params.formatted_address = encodeURIComponent(hzQuery.formatted_address);
      var queryMarker = hzQuery.geolocation;
      if (queryMarker){
        params.latlng = [queryMarker.lat, queryMarker.lng].join(',');
      } else {
        params.latlng = [HZApp.map.getCenter().lat(), HZApp.map.getCenter().lng()].join(','); 
      }
      
      params.locale = document.documentElement.lang; //jshint ignore: line
      params.zoom = HZApp.map.getZoom(); 

      return ("?latlng=" + params.latlng + 
              "&zoom=" + params.zoom + 
              "&formatted_address=" + params.formatted_address + 
              "&locale=" + params.locale + 
              "&hubzone=" + params.hubzone);
    },
    requestReportError: function(){
      $('#report-waiting').html('Error Generating Report');
      HZApp.Report.clearReportWaiting(7500);
    },
    showReportWaiting: function(){
      $('#report-waiting').html('Generating Report...');
      $('#report-waiting').show();
    },
    hideReportWaiting: function(){
      $('#report-waiting').html('Report Created');
      HZApp.Report.clearReportWaiting(5000);
    },
    clearReportWaiting: function(timeout){
      setTimeout(function(){
        $('#report-waiting').html();
        $('#report-waiting').hide();
      }, timeout);
    }
  };
})();





