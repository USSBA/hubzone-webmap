// reporting utility
HZApp.Report = (function(){

  //adds listeners
  $(function() {
    $(document).bind("keydown", HZApp.Report.catchKeyStrokeToPrint);
    $(document).on('click','#map-print', HZApp.Report.requestReport);
  });

  return {
    catchKeyStrokeToPrint: function(e){
      if((e.ctrlKey || e.metaKey) && e.keyCode === 80){
        e.preventDefault();
        HZApp.Report.requestReport();
      } else {
        return;
      }
    },
    requestReport: function() {  // fetch the app state to send off to the report
      HZApp.Report.showReportWaiting();
      var reportCenter;
      var searchAddress = HZApp.HZQuery.formatted_address;
      var queryMarker = HZApp.Markers.hzQueryMarker.markers[0];
      if (queryMarker){
        reportCenter = [queryMarker.getPosition().lat(), queryMarker.getPosition().lng()].join(',');
      } else {
        reportCenter = [HZApp.map.getCenter().lat(), HZApp.map.getCenter().lng()].join(','); 
      }
      var mapZoom = HZApp.map.getZoom();

      var url = 'map/report?';
          url += 'latlng=' + reportCenter;
          url += '&zoom=' + mapZoom;
          url += '&formatted_address=' + encodeURIComponent(searchAddress);

      // window.open(url, '_blank');

      var req = new XMLHttpRequest();
      req.open("GET", url, true);
      req.responseType = "blob";
      req.onerror = HZApp.Report.requestReportError;
      req.onload = function (event) { // jshint ignore: line
        HZApp.Report.hideReportWaiting();
        var blob = req.response;
        var link=document.createElement('a');
        link.target = '_blank';
        link.href=window.URL.createObjectURL(blob);
        link.download="hz_report" + "_address_" + searchAddress.replace(' ', '-') + "_latlng_" + reportCenter  + ".pdf";
        link.click();
        window.URL.revokeObjectURL(link.href);
      };

      req.send();
    },
    requestReportError: function(){
      $('#report-waiting').html('Error Generating Report');
      
      setTimeout(function(){
        $('#report-waiting').html();
        $('#report-waiting').hide();
      }, 7500);
    },
    showReportWaiting: function(){
      $('#report-waiting').html('Generating Report...');
      $('#report-waiting').show();
    },
    hideReportWaiting: function(){
      $('#report-waiting').html('Report Created');
      
      setTimeout(function(){
        $('#report-waiting').html();
        $('#report-waiting').hide();
      }, 5000);
    }
  };
})();





